name: Reference Repo Updated

on:
  repository_dispatch:
    types: [reference-repo-updated]
  workflow_dispatch:
    inputs:
      sha:
        description: 'Commit SHA (for testing)'
        default: 'test-sha'
      message:
        description: 'Commit message (for testing)'
        default: 'Manual test trigger'

permissions:
  issues: write

jobs:
  create-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Create sync issue
        uses: actions/github-script@v7
        with:
          script: |
            const isDispatch = context.eventName === 'repository_dispatch';
            const payload = context.payload;

            let message, sha;
            if (isDispatch && payload.client_payload) {
              message = payload.client_payload.message || 'No message';
              sha = payload.client_payload.sha || 'unknown';
            } else if (payload.inputs) {
              message = payload.inputs.message || 'Manual test';
              sha = payload.inputs.sha || 'manual';
            } else {
              message = 'Unknown trigger';
              sha = 'unknown';
            }

            const shortSha = sha.substring(0, 7);
            const titleMessage = message.length > 50
              ? message.substring(0, 50) + '...'
              : message;

            const body = [
              'The reference repo (ClaudeCode-DevPlanBuilder) has been updated.',
              '',
              `**Commit**: [\`${shortSha}\`](https://github.com/mmorris35/ClaudeCode-DevPlanBuilder/commit/${sha})`,
              `**Message**: ${message}`,
              '',
              `[View full diff](https://github.com/mmorris35/ClaudeCode-DevPlanBuilder/commit/${sha})`,
              '',
              '---',
              '',
              'Review the changes and sync the MCP server if needed.'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”„ Reference repo updated: ${titleMessage}`,
              body: body,
              labels: ['sync', 'reference-repo']
            });
